{% extends 'core/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä Balance: <span class="text-primary">{{ nombre_mes }} {{ anio_actual }}</span></h2>
    <button class="btn btn-outline-secondary d-print-none" onclick="window.print()">
        <i class="bi bi-printer"></i> Imprimir
    </button>
</div>

<div class="card p-3 mb-4 shadow-sm bg-light d-print-none">
    <form method="GET" class="row g-2 align-items-end">
        
        <div class="col-md-3">
            <label class="small fw-bold text-muted">Mes</label>
            <select name="mes" class="form-select">
                {% for num, nombre in lista_meses %}
                    <option value="{{ num }}" {% if num == mes_actual %}selected{% endif %}>
                        {{ nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="small fw-bold text-muted">A√±o</label>
            <select name="anio" class="form-select">
                {% for a in lista_anios %}
                    <option value="{{ a }}" {% if a == anio_actual %}selected{% endif %}>
                        {{ a }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-5">
            <label class="small fw-bold text-muted">Filtrar por Fuente de Ingreso</label>
            <select name="obra_social" class="form-select">
                <option value="">üè† Balance General (Todo)</option>
                {% for os in obras_sociales %}
                    <option value="{{ os.pk }}" {% if os.pk == os_actual %}selected{% endif %}>
                        Solo {{ os.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel"></i> Aplicar
            </button>
        </div>
    </form>
</div>

<div class="row mb-4 text-center">
    <div class="col-md-4">
        <div class="card shadow-sm border-start border-success border-5 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">Caja Diaria (Consultorio)</h6>
                <h3 class="display-6 text-success fw-bold">${{ ingresos_turnos }}</h3>
                <small class="text-muted">Pagos recibidos en mano/MP</small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-start border-primary border-5 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">Liquidaciones (Banco)</h6>
                <h3 class="display-6 text-primary fw-bold">${{ ingresos_os }}</h3>
                <small class="text-muted">Dep√≥sitos de Obras Sociales</small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-start border-danger border-5 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">Gastos Operativos</h6>
                <h3 class="display-6 text-danger fw-bold">-${{ egresos }}</h3>
                <small class="text-muted">Alquiler, Insumos, etc.</small>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-body text-center py-4 {% if resultado >= 0 %}bg-success-subtle{% else %}bg-danger-subtle{% endif %}">
        <h2 class="mb-0">
            Resultado del Per√≠odo: 
            <span class="fw-bold {% if resultado >= 0 %}text-success{% else %}text-danger{% endif %}">
                ${{ resultado }}
            </span>
        </h2>
    </div>
</div>

<div class="row d-print-none">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Registrar Movimientos Extra</div>
            <div class="card-body d-flex gap-2">
                <a href="{% url 'crear_gasto' %}" class="btn btn-outline-danger w-50">
                    <i class="bi bi-dash-circle"></i> Nuevo Gasto
                </a>
                <a href="{% url 'crear_liquidacion' %}" class="btn btn-outline-primary w-50">
                    <i class="bi bi-bank"></i> Ingreso Obra Social
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="alert alert-warning mb-0 small">
            <i class="bi bi-lightbulb-fill"></i> <strong>Nota:</strong> Los gastos generales (Alquiler, Luz) se restan siempre al total del mes, independientemente de la Obra Social que filtres, ya que son costos fijos del consultorio.
        </div>
    </div>
</div>

<hr class="my-5">

<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-cash-coin"></i> Detalle de Ingresos (Caja Diaria)</span>
        <span class="badge bg-white text-success">{{ movimientos_turnos.count }} Movimientos</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th>Fecha</th>
                    <th>Paciente</th>
                    <th>Tratamiento</th>
                    <th>Forma de Pago</th>
                    <th class="text-end">Monto Ingresado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for t in movimientos_turnos %}
                <tr>
                    <td>{{ t.fecha|date:"d/m" }} <small class="text-muted">{{ t.hora|time:"H:i" }}</small></td>
                    <td class="fw-bold">{{ t.paciente }}</td>
                    <td>{{ t.tratamiento }}</td>
                    <td>
                        {% if t.metodo_pago == 'EFECTIVO' %}
                            <span class="badge bg-success bg-opacity-10 text-success border border-success">Efectivo</span>
                        {% else %}
                            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">Transferencia</span>
                        {% endif %}
                    </td>
                    <td class="text-end fw-bold text-success">+ ${{ t.monto_pagado }}</td>
                    <td class="text-end">
                        <a href="{% url 'editar_turno' t.pk %}" class="btn btn-sm btn-light border" title="Ver Turno">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center p-4 text-muted">
                        No hubo ingresos por caja en este per√≠odo (o aplicaste un filtro que los oculta).
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-bank"></i> Detalle Liquidaciones (Banco)
            </div>
            <div class="list-group list-group-flush">
                {% for liq in movimientos_os %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">{{ liq.obra_social }}</div>
                        <small class="text-muted">{{ liq.fecha_ingreso|date:"d/m/Y" }} - {{ liq.periodo|default:"-" }}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-primary fw-bold">+ ${{ liq.monto_total }}</span>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'editar_liquidacion' liq.pk %}" class="btn btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                            <a href="{% url 'borrar_liquidacion' liq.pk %}" class="btn btn-outline-danger" title="Borrar"><i class="bi bi-trash"></i></a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">No hay ingresos bancarios en este per√≠odo.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-cart-x"></i> Detalle Gastos
            </div>
            <div class="list-group list-group-flush">
                {% for g in movimientos_gastos %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">{{ g.categoria }}</div>
                        <small class="text-muted">{{ g.fecha|date:"d/m/Y" }} - {{ g.descripcion|default:"-" }}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-danger fw-bold">- ${{ g.monto }}</span>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'editar_gasto' g.pk %}" class="btn btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                            <a href="{% url 'borrar_gasto' g.pk %}" class="btn btn-outline-danger" title="Borrar"><i class="bi bi-trash"></i></a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">No hay gastos registrados en este per√≠odo.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}